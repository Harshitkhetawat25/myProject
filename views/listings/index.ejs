<% layout("layouts/boilerplate.ejs") %>

<!-- Search Results Header -->
<% if (query) { %>
<div class="search-results-header">
    <div class="container">
        <div class="search-info">
            <h2 class="search-title">Search Results</h2>
            <p class="search-query">Showing results for "<span class="query-text"><%=query%></span>"</p>
        </div>
    </div>
</div>
<% } %>

<!-- Enhanced Filter Section -->
<div class="filters-section">
    <div class="container">
        <!-- Mobile Filter Toggle -->
        <button class="mobile-filter-toggle d-lg-none" id="filterToggleBtn">
            <i class="fas fa-sliders-h"></i>
            <span>Filters</span>
        </button>

        <!-- Filter Navigation -->
        <div class="filters-container" id="filtersContainer">
            <div class="filters-wrapper">
                <div class="filter-item <%= !activeCategory ? 'active' : '' %>">
                    <a href="/listings" class="filter-link">
                        <div class="filter-icon">
                            <i class="fas fa-th-large"></i>
                        </div>
                        <span class="filter-label">All</span>
                    </a>
                </div>

                <div class="filter-item <%= activeCategory === 'Trending' ? 'active' : '' %>">
                    <a href="/listings/category/Trending" class="filter-link">
                        <div class="filter-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <span class="filter-label">Trending</span>
                    </a>
                </div>

                <div class="filter-item <%= activeCategory === 'Rooms' ? 'active' : '' %>">
                    <a href="/listings/category/Rooms" class="filter-link">
                        <div class="filter-icon">
                            <i class="fas fa-bed"></i>
                        </div>
                        <span class="filter-label">Rooms</span>
                    </a>
                </div>

                <div class="filter-item <%= activeCategory === 'Iconic cities' ? 'active' : '' %>">
                    <a href="/listings/category/Iconic cities" class="filter-link">
                        <div class="filter-icon">
                            <i class="fas fa-city"></i>
                        </div>
                        <span class="filter-label">Iconic Cities</span>
                    </a>
                </div>

                <div class="filter-item <%= activeCategory === 'Mountains' ? 'active' : '' %>">
                    <a href="/listings/category/Mountains" class="filter-link">
                        <div class="filter-icon">
                            <i class="fas fa-mountain"></i>
                        </div>
                        <span class="filter-label">Mountains</span>
                    </a>
                </div>

                <div class="filter-item <%= activeCategory === 'Castles' ? 'active' : '' %>">
                    <a href="/listings/category/Castles" class="filter-link">
                        <div class="filter-icon">
                            <i class="fas fa-chess-rook"></i>
                        </div>
                        <span class="filter-label">Castles</span>
                    </a>
                </div>

                <div class="filter-item <%= activeCategory === 'Amazing Pools' ? 'active' : '' %>">
                    <a href="/listings/category/Amazing Pools" class="filter-link">
                        <div class="filter-icon">
                            <i class="fas fa-swimming-pool"></i>
                        </div>
                        <span class="filter-label">Pools</span>
                    </a>
                </div>

                <div class="filter-item <%= activeCategory === 'Camping' ? 'active' : '' %>">
                    <a href="/listings/category/Camping" class="filter-link">
                        <div class="filter-icon">
                            <i class="fas fa-campground"></i>
                        </div>
                        <span class="filter-label">Camping</span>
                    </a>
                </div>

                <div class="filter-item <%= activeCategory === 'Farms' ? 'active' : '' %>">
                    <a href="/listings/category/Farms" class="filter-link">
                        <div class="filter-icon">
                            <i class="fas fa-tractor"></i>
                        </div>
                        <span class="filter-label">Farms</span>
                    </a>
                </div>

                <div class="filter-item <%= activeCategory === 'Arctic' ? 'active' : '' %>">
                    <a href="/listings/category/Arctic" class="filter-link">
                        <div class="filter-icon">
                            <i class="fas fa-snowflake"></i>
                        </div>
                        <span class="filter-label">Arctic</span>
                    </a>
                </div>

                <div class="filter-item <%= activeCategory === 'Boats' ? 'active' : '' %>">
                    <a href="/listings/category/Boats" class="filter-link">
                        <div class="filter-icon">
                            <i class="fas fa-ship"></i>
                        </div>
                        <span class="filter-label">Boats</span>
                    </a>
                </div>

                <div class="filter-item <%= activeCategory === 'Domes' ? 'active' : '' %>">
                    <a href="/listings/category/Domes" class="filter-link">
                        <div class="filter-icon">
                            <i class="fas fa-igloo"></i>
                        </div>
                        <span class="filter-label">Domes</span>
                    </a>
                </div>
            </div>

            <!-- Tax Toggle -->
            <div class="tax-toggle-container">
                <div class="tax-toggle">
                    <span class="tax-label">Display total after taxes</span>
                    <div class="toggle-switch">
                        <input type="checkbox" id="taxToggle" class="toggle-input">
                        <label for="taxToggle" class="toggle-label">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Listings Grid -->
<div class="listings-section">
    <div class="container">
        <% if (allListings.length === 0) { %>
        <div class="no-results">
            <div class="no-results-content">
                <i class="fas fa-search no-results-icon"></i>
                <h3>No listings found</h3>
                <p>Try adjusting your search criteria or browse all listings</p>
                <a href="/listings" class="btn btn-primary">View All Listings</a>
            </div>
        </div>
        <% } else { %>
        <div class="listings-grid">
            <% for(let listing of allListings){ %>
            <div class="listing-card-container">
                <a href="/listings/<%=listing._id%>" class="listing-link">
                    <div class="listing-card">
                        <!-- Image Container -->
                        <div class="card-image-container">
                            <img src="<%=listing.image.url || 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=400'%>" 
                                 class="card-image" 
                                 alt="<%=listing.title%>"
                                 loading="lazy">
                            
                            <!-- Status Badges -->
                            <% if(listing.isBooked) { %>
                            <div class="status-badge booked-badge">
                                <i class="fas fa-calendar-times"></i>
                                <span>Booked</span>
                            </div>
                            <% } %>
                            
                            <!-- Wishlist Button -->
                            <button class="wishlist-btn" data-listing-id="<%=listing._id%>">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>

                        <!-- Card Content -->
                        <div class="card-content">
                            <div class="card-header">
                                <h3 class="listing-title"><%=listing.title%></h3>
                                <div class="listing-rating">
                                    <i class="fas fa-star"></i>
                                    <span>4.8</span>
                                </div>
                            </div>
                            
                            <div class="listing-location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span><%=listing.location%>, <%=listing.country%></span>
                            </div>
                            
                            <div class="listing-price">
                                <span class="price-amount">₹<%=listing.price.toLocaleString("en-IN")%></span>
                                <span class="price-period">per night</span>
                                <span class="tax-info">+ ₹<%=Math.round(listing.price * 0.18).toLocaleString("en-IN")%> taxes</span>
                            </div>

                            <% if(listing.isBooked && currUser && listing.owner._id.equals(currUser._id)) { %>
                            <div class="owner-status">
                                <span class="owner-badge">
                                    <i class="fas fa-check-circle"></i>
                                    Your listing is booked
                                </span>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </a>
            </div>
            <% } %>
        </div>
        <% } %>
    </div>
</div>

<style>

/* Search Results Header */
.search-results-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
}

.search-info {
    text-align: center;
}

.search-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.search-query {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0;
}

.query-text {
    font-weight: 600;
    color: #ffd700;
}

/* Filters Section */
.filters-section {
    background: #fff;
    border-bottom: 1px solid #e9ecef;
    padding: 1rem 0;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.mobile-filter-toggle {
    background: #fff;
    border: 2px solid #0d6efd;
    color: #0d6efd;
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    font-weight: 600;
    display: none;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    margin-bottom: 1rem;
    width: 100%;
    justify-content: center;
}

.mobile-filter-toggle:hover {
    background: #0d6efd;
    color: white;
    transform: translateY(-1px);
}

.filters-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 2rem;
    transition: all 0.3s ease;
}

.filters-wrapper {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    flex: 1;
    padding: 0.5rem 0;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.filters-wrapper::-webkit-scrollbar {
    display: none;
}

.filter-item {
    flex: 0 0 auto;
    transition: all 0.2s ease;
}

.filter-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem 1.5rem;
    text-decoration: none;
    color: #666;
    border-radius: 15px;
    transition: all 0.2s ease;
    min-width: 80px;
}

.filter-link:hover {
    color: #0d6efd;
    background: rgba(13, 110, 253, 0.05);
    transform: translateY(-2px);
}

.filter-item.active .filter-link {
    color: #0d6efd;
    background: rgba(13, 110, 253, 0.1);
    font-weight: 600;
}

.filter-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.filter-label {
    font-size: 0.9rem;
    text-align: center;
    white-space: nowrap;
}

/* Tax Toggle */
.tax-toggle-container {
    flex: 0 0 auto;
}

.tax-toggle {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    border: 2px solid #e9ecef;
    border-radius: 50px;
    background: white;
    transition: all 0.2s ease;
}

.tax-toggle:hover {
    border-color: #0d6efd;
}

.tax-label {
    font-size: 0.95rem;
    font-weight: 500;
    color: #333;
    white-space: nowrap;
}

.toggle-switch {
    position: relative;
}

.toggle-input {
    display: none;
}

.toggle-label {
    display: block;
    width: 50px;
    height: 24px;
    background: #ccc;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.2s ease;
}

.toggle-slider {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-input:checked + .toggle-label {
    background: #0d6efd;
}

.toggle-input:checked + .toggle-label .toggle-slider {
    transform: translateX(26px);
}

/* Listings Section */
.listings-section {
    padding: 2rem 0;
    min-height: 60vh;
}

.listings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
    padding: 1rem 0;
}

.listing-card-container {
    position: relative;
}

.listing-link {
    text-decoration: none;
    color: inherit;
    display: block;
}

.listing-card {
    background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.04);
}

.listing-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}

.card-image-container {
    position: relative;
    height: 250px;
    overflow: hidden;
}

.card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.listing-card:hover .card-image {
    transform: scale(1.05);
}

.status-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.85rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    backdrop-filter: blur(10px);
    z-index: 10;
}

.booked-badge {
    background: rgba(220, 53, 69, 0.9);
    color: white;
}

.wishlist-btn {
    position: absolute;
    top: 15px;
    left: 15px;
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    color: #666;
    transition: all 0.2s ease;
    backdrop-filter: blur(5px);
    z-index: 10;
}

.wishlist-btn:hover {
    background: rgba(255,255,255,1);
    color: #dc3545;
    transform: scale(1.1);
}

.card-content {
    padding: 1.5rem;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    gap: 1rem;
}

.listing-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin: 0;
    line-height: 1.3;
    flex: 1;
}

.listing-rating {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    color: #ffd700;
    font-weight: 600;
    font-size: 0.9rem;
    flex: 0 0 auto;
}

.listing-rating i {
    font-size: 0.8rem;
}

.listing-location {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #666;
    font-size: 0.95rem;
    margin-bottom: 1rem;
}

.listing-location i {
    color: #0d6efd;
    font-size: 0.85rem;
}

.listing-price {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.price-amount {
    font-size: 1.25rem;
    font-weight: 700;
    color: #333;
}

.price-period {
    color: #666;
    font-size: 0.9rem;
}

.tax-info {
    display: none;
    color: #666;
    font-size: 0.85rem;
    font-style: italic;
}

.tax-info.show {
    display: inline;
}

.owner-status {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
}

.owner-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #198754;
    font-size: 0.9rem;
    font-weight: 500;
}

/* No Results */
.no-results {
    text-align: center;
    padding: 4rem 2rem;
}

.no-results-content {
    max-width: 400px;
    margin: 0 auto;
}

.no-results-icon {
    font-size: 4rem;
    color: #ccc;
    margin-bottom: 1.5rem;
}

.no-results h3 {
    color: #333;
    margin-bottom: 1rem;
}

.no-results p {
    color: #666;
    margin-bottom: 2rem;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .listings-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }
}

@media (max-width: 992px) {
    .filters-container {
        flex-direction: column;
        gap: 1rem;
    }
    
    .tax-toggle-container {
        align-self: stretch;
    }
    
    .tax-toggle {
        justify-content: center;
    }
}

@media (max-width: 768px) {
    .mobile-filter-toggle {
        display: flex;
    }
    
    .filters-container {
        display: none;
        flex-direction: column;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        padding: 1rem;
        margin: 0 -1rem;
    }
    
    .filters-container.show {
        display: flex;
        animation: slideDown 0.3s ease;
    }
    
    .filters-wrapper {
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.75rem;
        overflow-x: visible;
    }
    
    .filter-item {
        flex: 0 0 auto;
    }
    
    .filter-link {
        padding: 0.75rem 1rem;
        min-width: 70px;
        border: 1px solid #e9ecef;
        background: #f8f9fa;
    }
    
    .filter-link:hover {
        border-color: #0d6efd;
    }
    
    .filter-item.active .filter-link {
        border-color: #0d6efd;
        background: rgba(13, 110, 253, 0.1);
    }
    
    .tax-toggle {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 10px;
    }
    
    .listings-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
    }
    
    .search-title {
        font-size: 2rem;
    }
    
    .card-content {
        padding: 1rem;
    }
    
    .listing-title {
        font-size: 1.1rem;
    }
}

@media (max-width: 576px) {
    .listings-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .filter-link {
        padding: 0.5rem 0.75rem;
        min-width: 60px;
    }
    
    .filter-icon {
        font-size: 1.2rem;
        margin-bottom: 0.25rem;
    }
    
    .filter-label {
        font-size: 0.8rem;
    }
    
    .tax-label {
        font-size: 0.9rem;
    }
}

/* Animations */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.listing-card {
    animation: slideInUp 0.6s ease-out;
    animation-fill-mode: both;
}

.listing-card:nth-child(1) { animation-delay: 0.1s; }
.listing-card:nth-child(2) { animation-delay: 0.2s; }
.listing-card:nth-child(3) { animation-delay: 0.3s; }
.listing-card:nth-child(4) { animation-delay: 0.4s; }
.listing-card:nth-child(5) { animation-delay: 0.5s; }
.listing-card:nth-child(6) { animation-delay: 0.6s; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mobile filter toggle with improved functionality
    const filterToggleBtn = document.getElementById('filterToggleBtn');
    const filtersContainer = document.getElementById('filtersContainer');
    
    if (filterToggleBtn && filtersContainer) {
        filterToggleBtn.addEventListener('click', function() {
            const isVisible = filtersContainer.classList.contains('show');
            
            if (isVisible) {
                filtersContainer.classList.remove('show');
                this.innerHTML = '<i class="fas fa-sliders-h"></i><span>Filters</span>';
            } else {
                filtersContainer.classList.add('show');
                this.innerHTML = '<i class="fas fa-times"></i><span>Hide Filters</span>';
            }
        });
        
        // Close filters when clicking outside on mobile
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768 && 
                !filterToggleBtn.contains(e.target) && 
                !filtersContainer.contains(e.target) &&
                filtersContainer.classList.contains('show')) {
                filtersContainer.classList.remove('show');
                filterToggleBtn.innerHTML = '<i class="fas fa-sliders-h"></i><span>Filters</span>';
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                filtersContainer.classList.remove('show');
                filterToggleBtn.innerHTML = '<i class="fas fa-sliders-h"></i><span>Filters</span>';
            }
        });
    }

     // Tax toggle functionality
    const taxToggle = document.getElementById('taxToggle');
    const taxInfoElements = document.querySelectorAll('.tax-info');
    
    if (taxToggle) {
        taxToggle.addEventListener('change', function() {
            taxInfoElements.forEach(element => {
                element.classList.toggle('show', this.checked);
            });
        });
    }

    // Wishlist functionality (placeholder)
    // Wishlist functionality
    const wishlistBtns = document.querySelectorAll('.wishlist-btn');
    wishlistBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const icon = this.querySelector('i');
            const isFilled = icon.classList.contains('fas');
            
            icon.classList.toggle('far', isFilled);
            icon.classList.toggle('fas', !isFilled);
            this.style.color = isFilled ? '#666' : '#dc3545';
        });
    });
});

    // Smooth scrolling for better UX
    const filterLinks = document.querySelectorAll('.filter-link');
    filterLinks.forEach(link => {
        link.addEventListener('click', function() {
            // Add loading state
            this.style.opacity = '0.7';
            this.style.pointerEvents = 'none';
        });
    });

    // Intersection Observer for animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.animationPlayState = 'running';
            }
        });
    }, observerOptions);

    document.querySelectorAll('.listing-card').forEach(card => {
        card.style.animationPlayState = 'paused';
        observer.observe(card);
    });

    // Performance optimization - lazy load images
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src || img.src;
                img.classList.remove('lazy');
                observer.unobserve(img);
            }
        });
    });

    document.querySelectorAll('.card-image').forEach(img => {
        imageObserver.observe(img);
    });

</script>